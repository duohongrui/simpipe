#' Simulate scRNA-seq Datasets
#'
#' This is the core function of simulating scRNA-seq datasets. Users can execute
#' this step without parameters estimation step as we will set some default parameters.
#' Otherwise, we provide an alternative choice to complete this step via establishing
#' Docker containers.
#'
#' @param method A character or a string of methods or NULL. It can be \code{all}
#' as all methods are used to estimate paramters from real data. If NULL, the
#' argument \code{parameters} must be generated by [simpipe::estimate_parameters()].
#' @param parameters NULL or the object generated by [simpipe::estimate_parameters()].
#' If NULL, you must input the argument \code{method} above and the default
#' parameters will be used to perform the simulation step.
#' @param other_prior A list with names of certain parameters. Some methods need
#' extra parameters to execute the estimation step, so you must input them. In
#' simulation step, the number of cells, genes, groups, batches, the percent of
#' DEGs and other variables are usually customed, so before simulating a dataset
#' you must point it out.
#' @param seed A random seed. An integer or a vector of integers. If you want to
#' simulate twice or more times by every method you have chosen, it should be a
#' vector. If you do not input this parameter, the default value(s) will be used.
#' @param return_format A character. Alternatives choices: list, SingleCellExperiment,
#' Seurat and h5ad.
#' @param verbose Logical. Whether to return messages or not.
#' @param use_docker Logical. Default is FALSE. Whether to execute the simulation
#' step by establishing a Docker container or not. Suggest that you would better
#' use Docker to execute the step in order to avoid the issues caused by coding
#' environment.
#'
#' @importFrom stringr str_split
#' @importFrom stats setNames
#'
#' @export
#'
simulate_datasets <- function(
  method = NULL,
  parameters = NULL,
  other_prior = list(),
  seed = simutils::random_seed(),
  return_format = "SingleCellExperiment",
  verbose = TRUE,
  use_docker = FALSE
){

  # Check-----------------------------------------------------------------------
  assertthat::assert_that(is.list(parameters) | is.null(parameters))
  if(is.null(method) & is.null(parameters)){
    stop("You must input information about either method or parameters!")
  }
  if(!is.null(parameters)){
    assertthat::assert_that("simpipe_estimation" %in% class(parameters))
  }
  # Prepare methods-------------------------------------------------------------
  if(is.null(method) & !is.null(parameters)){
    method <- stringr::str_split(names(parameters), pattern = "_", simplify = T)[, 2]
  }

  all_methods <- simmethods::get_method()
  if(method[1] == "all"){
    method <- names(all_methods)
  }
  assertthat::assert_that(all(method %in% names(all_methods)))

  # Run methods with each estimation and each method----------------------------

  result <- purrr::map(
    .x = seq_len(length(method)),
    .f = function(id) {
      seed <- ifelse(is.null(seed), random_seed(), seed)
      if(!is.null(parameters)){
        parameters <- parameters[[names(parameters)[id]]][["estimate_result"]]
      }
      if(use_docker){
        method_execute_container_simulate(
        parameters = parameters,
        method = method[id],
        other_prior = other_prior,
        return_format = return_format,
        seed = seed,
        verbose = verbose)
      }else{
        method_execute_function_simulate(
          parameters = parameters,
          method = method[id],
          other_prior = other_prior,
          return_format = return_format,
          seed = seed,
          verbose = verbose
        )
      }
    }
  )
  # Prepare list names----------------------------------------------------------
  if(is.null(parameters)){
    list_names <- method
  }else{
    list_names <- names(parameters)
  }
  result <- stats::setNames(result, list_names)
  return(result)
}

# result <- simulate_datasets(method = NULL,
#                             parameters = estimate_output,
#                             seed = 10,
#                             return_format = "h5ad",
#                             verbose = T,
#                             use_docker = TRUE)
#
# result2 <- simulate_datasets(method = NULL,
#                             parameters = estimate_output,
#                             seed = 10,
#                             return_format = "SingleCellExperiment",
#                             verbose = T,
#                             use_docker = TRUE)
#
# result3 <- simulate_datasets(method = NULL,
#                             parameters = estimate_output,
#                             seed = 10,
#                             return_format = "list",
#                             verbose = T,
#                             use_docker = TRUE)
#
# result4 <- simulate_datasets(method = NULL,
#                             parameters = estimate_output,
#                             seed = 10,
#                             return_format = "Seurat",
#                             verbose = T,
#                             use_docker = TRUE)
#
# result5 <- simulate_datasets(method = "splat",
#                             parameters = NULL,
#                             seed = 10,
#                             return_format = "Seurat",
#                             verbose = T,
#                             use_docker = TRUE)
#
# result6 <- simulate_datasets(method = NULL,
#                              parameters = estimate_output,
#                              seed = 10,
#                              return_format = "Seurat",
#                              verbose = T,
#                              use_docker = TRUE,
#                              other_prior = list(batchCells = c(1000,1000),
#                                                 group.prob = c(0.5, 0.5),
#                                                 nGenes = 5000))
#
# result7 <- simulate_datasets(method = NULL,
#                              parameters = estimate_output,
#                              seed = 10,
#                              return_format = "Seurat",
#                              verbose = T,
#                              use_docker = TRUE,
#                              other_prior = list(batchCells = c(1000,1000),
#                                                 group.prob = c(0.5, 0.5),
#                                                 nGenes = 5000))
